@page "/surveys"
@inject NavigationManager Nav

<h1 class="page-h1">Surveys</h1>

<form class="surveys-toolbar" @onsubmit="OnSearchSubmit" @onsubmit:preventDefault="true">
    <div class="toolbar-left">
        @if (ShowFilters)
        {
            <div class="filters-backdrop" @onclick="CloseFilters"></div>
        }
        <div class="search-shell">
            <input class="survey-search search-input" placeholder="Search survey list (ID / title / OMB / sample)…"
                   @bind="SearchText" @bind:event="oninput" @onfocus="ShowViewAll" />

            <button class="search-filter-btn" type="button" @onclick="ToggleFilters" title="Filters">
                <span class="bi bi-sliders" aria-hidden="true"></span>
            </button>

            @if (ShowFilters)
            {
                <div class="filters-pop" @onclick:stopPropagation="true">
                    <div class="filters-title">Filters</div>

                    <div class="filters-group">
                        <div class="filters-subtitle">Start Date – Stop Date</div>
                        <div class="filters-inline">
                            <InputDate class="select-lite" @bind-Value="StartDateFilter" />
                            <InputDate class="select-lite" @bind-Value="StopDateFilter" />
                        </div>
                    </div>

                    <div class="filters-group">
                        <div class="filters-subtitle">States</div>
                        <div class="filters-checks">
                            @foreach (var state in States)
                            {
                                <label class="check-pill">
                                    <input type="checkbox"
                                           checked="@StateSelections.Contains(state)"
                                           @onchange="e => ToggleSelection(StateSelections, state, e)" />
                                    <span>@state</span>
                                </label>
                            }
                        </div>
                    </div>

                    <div class="filters-group">
                        <div class="filters-subtitle">Regions</div>
                        <div class="filters-checks">
                            @foreach (var region in Regions)
                            {
                                <label class="check-pill">
                                    <input type="checkbox"
                                           checked="@RegionSelections.Contains(region)"
                                           @onchange="e => ToggleSelection(RegionSelections, region, e)" />
                                    <span>@region</span>
                                </label>
                            }
                        </div>
                    </div>

                    <div class="filters-group">
                        <div class="filters-subtitle">Mode</div>
                        <div class="filters-checks">
                            @foreach (var mode in Modes)
                            {
                                <label class="check-pill">
                                    <input type="checkbox"
                                           checked="@ModeSelections.Contains(mode)"
                                           @onchange="e => ToggleSelection(ModeSelections, mode, e)" />
                                    <span>@mode</span>
                                </label>
                            }
                        </div>
                    </div>

                    <div class="filters-group">
                        <div class="filters-subtitle">Show # of results</div>
                        <select class="select-lite" @bind="ResultsSize">
                            <option value="">Default</option>
                            @foreach (var size in ResultsSizes)
                            {
                                <option value="@size">@size</option>
                            }
                        </select>
                    </div>

                    <div class="filters-group">
                        <div class="filters-subtitle">Status</div>
                        <div class="filters-checks">
                            @foreach (var status in StatusOptions)
                            {
                                <label class="check-pill">
                                    <input type="checkbox"
                                           checked="@StatusSelections.Contains(status)"
                                           @onchange="e => ToggleSelection(StatusSelections, status, e)" />
                                    <span>@status</span>
                                </label>
                            }
                        </div>
                    </div>

                    <div class="filters-group">
                        <div class="filters-subtitle">Year</div>
                        <div class="filters-checks">
                            @foreach (var y in Years)
                            {
                                <label class="check-pill">
                                    <input type="checkbox"
                                           checked="@YearSelections.Contains(y)"
                                           @onchange="e => ToggleSelection(YearSelections, y, e)" />
                                    <span>@y</span>
                                </label>
                            }
                        </div>
                    </div>

                    <div class="filters-actions">
                        <button class="btn-lite" type="button" @onclick="ClearFilters">Clear</button>
                        <button class="btn-primary" type="button" @onclick="() => ShowFilters = false">Done</button>
                    </div>
                </div>
            }
        </div>

        @if (SelectedFilterChips.Any())
        {
            <div class="search-chips">
                @foreach (var chip in SelectedFilterChips)
                {
                    <button type="button" class="chip" @onclick="chip.OnRemove">
                        <span class="chip-x">×</span>
                        <span>@chip.Label</span>
                    </button>
                }
            </div>
        }
    </div>
</form>

<div class="search-hint">
    <button class="btn-lite" type="button" @onclick="ViewAll">View all surveys</button>
    <span class="search-hint-text">or type to refine your search.</span>
</div>

<section class="stats-panel">
    <div class="stats-header">Statistics</div>
    <div class="stats-grid">
        <div class="stat-tile">
        <div class="stat-label">Number of survey instruments served to date:</div>
            <div class="stat-value">0</div>
        </div>
        <div class="stat-tile">
        <div class="stat-label">Number of respondents sampled to date:</div>
            <div class="stat-value">3,562,523</div>
        </div>
        <div class="stat-tile">
        <div class="stat-label">Number of responses to date:</div>
            <div class="stat-value">1,097,260</div>
        </div>
        <div class="stat-tile">
        <div class="stat-label">Response rate to date:</div>
            <div class="stat-value">5.4417%</div>
        </div>
        <div class="stat-tile">
        <div class="stat-label">Average customer experience:</div>
            <div class="stat-value">Not available</div>
        </div>
    </div>
</section>

@code {
    private string SearchText { get; set; } = "";
    private bool ShowViewAllOption { get; set; }
    private bool ShowFilters { get; set; }
    private DateTime? StartDateFilter { get; set; }
    private DateTime? StopDateFilter { get; set; }
    private string ResultsSize { get; set; } = "";

    private readonly List<string> Years = new() { "2027", "2026", "2025" };
    private readonly List<string> Regions = new() { "SOR", "NWR", "MTR", "DLR", "PCR", "NER", "EMR", "HLR", "GLR", "UMR", "NPR", "SPR" };
    private readonly List<string> States = new()
    {
        "AL", "AK", "AZ", "AR", "CA", "CO", "CT", "DE", "DC", "FL",
        "GA", "HI", "ID", "IL", "IN", "IA", "KS", "KY", "LA", "ME",
        "MD", "MA", "MI", "MN", "MS", "MO", "MT", "NE", "NV", "NH",
        "NJ", "NM", "NY", "NC", "ND", "OH", "OK", "OR", "PA", "RI",
        "SC", "SD", "TN", "TX", "UT", "VT", "VA", "WA", "WV", "WI", "WY", "PR"
    };
    private readonly List<string> Modes = new() { "CAWI", "CATI", "CAPI", "Paper" };
    private readonly List<string> ResultsSizes = new() { "10", "20", "50", "All" };
    private readonly List<string> StatusOptions = new() { "Not started", "In progress", "Blocked", "Overdue" };

    private HashSet<string> StateSelections { get; } = new(StringComparer.OrdinalIgnoreCase);
    private HashSet<string> RegionSelections { get; } = new(StringComparer.OrdinalIgnoreCase);
    private HashSet<string> ModeSelections { get; } = new(StringComparer.OrdinalIgnoreCase);
    private HashSet<string> StatusSelections { get; } = new(StringComparer.OrdinalIgnoreCase);
    private HashSet<string> YearSelections { get; } = new(StringComparer.OrdinalIgnoreCase);

    private void ShowViewAll() => ShowViewAllOption = true;
    private void CloseFilters() => ShowFilters = false;

    private void ViewAll()
    {
        Nav.NavigateTo($"/surveys/results{BuildQuery(includeViewAll: true)}");
    }

    private void OnSearchSubmit()
    {
        var includeViewAll = string.IsNullOrWhiteSpace(SearchText);
        Nav.NavigateTo($"/surveys/results{BuildQuery(includeViewAll)}");
    }

    private void ToggleFilters() => ShowFilters = !ShowFilters;

    private void ClearFilters()
    {
        StartDateFilter = null;
        StopDateFilter = null;
        StateSelections.Clear();
        RegionSelections.Clear();
        ModeSelections.Clear();
        ResultsSize = "";
        StatusSelections.Clear();
        YearSelections.Clear();
    }

    private IEnumerable<FilterChip> SelectedFilterChips => BuildFilterChips();

    private IEnumerable<FilterChip> BuildFilterChips()
    {
        var chips = new List<FilterChip>();

        if (!string.IsNullOrWhiteSpace(SearchText))
            chips.Add(new FilterChip(SearchText.Trim(), () => SearchText = ""));

        chips.AddRange(StateSelections.Select(s => new FilterChip(s, () => StateSelections.Remove(s))));
        chips.AddRange(RegionSelections.Select(r => new FilterChip(r, () => RegionSelections.Remove(r))));
        chips.AddRange(ModeSelections.Select(m => new FilterChip(m, () => ModeSelections.Remove(m))));
        chips.AddRange(StatusSelections.Select(s => new FilterChip(s, () => StatusSelections.Remove(s))));
        chips.AddRange(YearSelections.Select(y => new FilterChip(y, () => YearSelections.Remove(y))));

        if (StartDateFilter.HasValue)
            chips.Add(new FilterChip(StartDateFilter.Value.ToString("yyyy-MM-dd"), () => StartDateFilter = null));

        if (StopDateFilter.HasValue)
            chips.Add(new FilterChip(StopDateFilter.Value.ToString("yyyy-MM-dd"), () => StopDateFilter = null));

        if (!string.IsNullOrWhiteSpace(ResultsSize))
            chips.Add(new FilterChip($"{ResultsSize} results", () => ResultsSize = ""));

        return chips;
    }

    private sealed record FilterChip(string Label, Action OnRemove);

    private static void ToggleSelection(HashSet<string> set, string value, ChangeEventArgs e)
    {
        if (e.Value is bool isChecked && isChecked)
        {
            set.Add(value);
        }
        else
        {
            set.Remove(value);
        }
    }

    private string BuildQuery(bool includeViewAll)
    {
        var queryParts = new List<string>();

        if (!string.IsNullOrWhiteSpace(SearchText))
        {
            queryParts.Add($"q={Uri.EscapeDataString(SearchText.Trim())}");
        }

        if (StartDateFilter.HasValue)
        {
            queryParts.Add($"start={StartDateFilter.Value:yyyy-MM-dd}");
        }

        if (StopDateFilter.HasValue)
        {
            queryParts.Add($"stop={StopDateFilter.Value:yyyy-MM-dd}");
        }

        if (StateSelections.Count > 0)
        {
            var encoded = string.Join(",", StateSelections.Select(Uri.EscapeDataString));
            queryParts.Add($"state={encoded}");
        }

        if (RegionSelections.Count > 0)
        {
            var encoded = string.Join(",", RegionSelections.Select(Uri.EscapeDataString));
            queryParts.Add($"region={encoded}");
        }

        if (ModeSelections.Count > 0)
        {
            var encoded = string.Join(",", ModeSelections.Select(Uri.EscapeDataString));
            queryParts.Add($"mode={encoded}");
        }

        if (!string.IsNullOrWhiteSpace(ResultsSize))
        {
            queryParts.Add($"size={Uri.EscapeDataString(ResultsSize)}");
        }

        if (StatusSelections.Count > 0)
        {
            var encoded = string.Join(",", StatusSelections.Select(Uri.EscapeDataString));
            queryParts.Add($"status={encoded}");
        }

        if (YearSelections.Count > 0)
        {
            var encoded = string.Join(",", YearSelections.Select(Uri.EscapeDataString));
            queryParts.Add($"year={encoded}");
        }

        if (includeViewAll)
        {
            queryParts.Add("viewAll=true");
        }

        return queryParts.Count == 0 ? "" : $"?{string.Join("&", queryParts)}";
    }
}
