@page "/"
@using app_blazor.Components.Shared
@using static app_blazor.Components.Shared.TaskCalendar
@inject NavigationManager Navigation
@inject IJSRuntime Js

<h2 class="page-h2">Dashboard</h2>

<div class="dashboard-grid" @onclick="ClearSelection">
    <div class="dashboard-lower">
        <div class="dashboard-stack">
            <section class="panel reports-panel">
                <a class="panel-title-link" href="/reports">Reports Hub</a>
                <div class="reports-summary">
                    <div class="reports-kpis">
                        <div class="omb-tile">
                            <div class="omb-label">Total Reports</div>
                            <div class="omb-value">@ReportsTotal</div>
                        </div>
                        <div class="omb-tile">
                            <div class="omb-label">Ready</div>
                            <div class="omb-value">@ReportsReady</div>
                        </div>
                        <div class="omb-tile">
                            <div class="omb-label">Draft</div>
                            <div class="omb-value">@ReportsDraft</div>
                        </div>
                    </div>
                    <div class="reports-preview">
                        <div class="reports-preview-header">Recent Reports</div>
                        <ul>
                            @foreach (var report in RecentReports)
                            {
                                <li>
                                    <span class="report-id">@report.Id</span>
                                    <a class="report-title-link" href="/reports">@report.Title</a>
                                    <span class="report-status @ReportStatusClass(report.Status)">@report.Status</span>
                                    <span class="report-date">@report.GeneratedAt.ToString("yyyy-MM-dd")</span>
                                </li>
                            }
                        </ul>
                    </div>
                </div>
                <div class="omb-actions">
                </div>
            </section>

            <section class="panel omb-panel">
                <a class="panel-title-link" href="/omb-dockets">OMB Dockets</a>
                <div class="omb-summary-grid omb-compact">
                    <div class="omb-tile">
                        <div class="omb-label">Total Dockets</div>
                        <div class="omb-value">@OmbTotal</div>
                    </div>
                    <div class="omb-tile">
                        <div class="omb-label">Pending Approval</div>
                        <div class="omb-value">@OmbPending</div>
                    </div>
                    <div class="omb-tile">
                        <div class="omb-label">Approved (last 30 days)</div>
                        <div class="omb-value">@OmbApprovedRecent</div>
                    </div>
                </div>
                <div class="omb-actions">
                    <a class="omb-latest-link" href="/omb-dockets/details">Latest: @LatestDocketId — @LatestDocketTitle</a>
                </div>
            </section>

            <section class="panel budget-panel">
                <a class="panel-title-link" href="/budget">Budget Snapshot</a>
                <div class="budget-grid">
                    <div class="budget-ring" style="--budget-pct:@BudgetSpentPct%">
                        <div class="budget-ring-inner">
                            <div class="budget-ring-label">Spent</div>
                            <div class="budget-ring-value">@BudgetSpentPct%</div>
                        </div>
                    </div>
                    <div class="budget-meta">
                        <div class="budget-row">
                            <span class="budget-label">Allocated</span>
                            <span class="budget-value">@BudgetAllocatedDisplay</span>
                        </div>
                        <div class="budget-row">
                            <span class="budget-label">Spent</span>
                            <span class="budget-value">@BudgetSpentDisplay</span>
                        </div>
                        <div class="budget-row">
                            <span class="budget-label">Remaining</span>
                            <span class="budget-value">@BudgetRemainingDisplay</span>
                        </div>
                        <div class="budget-bar">
                            <div class="budget-bar-fill" style="width:@BudgetSpentPct%"></div>
                        </div>
                        <div class="budget-hint">@BudgetAlert</div>
                    </div>
                </div>
                <div class="omb-actions">
                </div>
            </section>
        </div>

        <section class="panel calendar-panel dashboard-lower-calendar">
            <div class="calendar-panel-header">
                <a class="panel-title-link" href="/calendar">My Tasks</a>
                <div class="calendar-view-toggle">
                    <button type="button" class="button-lite @(ShowTaskList ? "active" : "")" @onclick="() => ShowTaskList = true">List View</button>
                    <button type="button" class="button-lite @(!ShowTaskList ? "active" : "")" @onclick="() => ShowTaskList = false">Calendar View</button>
                </div>
            </div>

            @if (ShowTaskList)
            {
                <div class="tasks-list">
                    @if (Tasks.Count == 0)
                    {
                        <div class="tasks-empty">No tasks yet.</div>
                    }
                    else
                    {
                        <table class="table-lite">
                            <thead>
                                <tr>
                                    <th style="width: 30%">Task</th>
                                    <th style="width: 24%">Survey</th>
                                    <th style="width: 30%">Due Date</th>
                                    <th style="width: 16%">Status</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var t in Tasks)
                                {
                                    <tr class="task-row @(SelectedEventId == t.Id ? "selected" : "")"
                                        @onclick="() => SelectTask(t)" @onclick:stopPropagation="true">
                                        <td>
                                            <a class="task-link" href="@GetSurveyLink(t.SurveyId)" @onclick:stopPropagation="true">
                                                @t.Task
                                            </a>
                                        </td>
                                        <td>
                                            <a class="task-link" href="@GetSurveyLink(t.SurveyId)" @onclick:stopPropagation="true">
                                                @t.SurveyId @t.SurveyTitle
                                            </a>
                                        </td>
                                        <td>@t.DueAt.ToString("MMM d, h:mm tt")</td>
                                        <td><span class="pill @GetPill(t.Status)">@t.Status</span></td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    }
                </div>
            }
            else
            {
                <TaskCalendar Events="CalendarEvents"
                              @bind-View="CalendarView"
                              @bind-SelectedEventId="SelectedEventId" />
            }
        </section>
    </div>
</div>

@code {
    private TaskCalendar.CalendarViewMode CalendarView = TaskCalendar.CalendarViewMode.Month;
    private int? SelectedEventId { get; set; }
    private bool ShowTaskList { get; set; } = false;


    // DueAt includes the time
    private record TaskRow(int Id, string Task, int SurveyId, string SurveyTitle, DateTime DueAt, string Status);

    private List<TaskRow> Tasks = new()
    {
        new(1, "Finalize survey iteration dates", 1001, "Crop Yield Survey",
            new DateTime(2026, 1, 26, 17, 0, 0), 
            "In progress"), // 5:00PM
        new(2, "Validate status master (pre-publish)", 1002, "Ag Census Pilot",
            new DateTime(2026, 1, 18, 10, 0, 0), 
            "Blocked"), //10:00 AM
        new(3, "Review questionnaire link (instrument)", 1001, "Crop Yield Survey",
            new DateTime(2026, 1, 22, 14, 30, 0), 
            "Not started"), // 2:30 PM
        new(4, "Resolve schedule conflict (overlap)", 1004, "Dairy Inventory",
            new DateTime(2026, 1, 17, 9, 0, 0), 
            "Overdue"), //9:00 AM
        new(5, "Confirm CAWI mode dates", 1003, "Farm Labor Study",
            new DateTime(2026, 1, 11, 16, 0, 0), 
            "In progress"), // 4:00 PM
    };

    private record OmbDocketRow(string Id, string Title, string Status, DateTime UpdatedAt);

    private readonly List<OmbDocketRow> OmbDockets = new()
    {
        new("OMB-2026-001", "Crop Yield Survey OMB Renewal", "Approved", new DateTime(2026, 1, 15)),
        new("OMB-2026-014", "Agricultural Census Pilot", "Pending", new DateTime(2026, 1, 17)),
        new("OMB-2026-099", "Irrigation & Water Use", "Approved", new DateTime(2026, 1, 14)),
        new("OMB-2026-203", "Dairy Inventory Update", "Draft", new DateTime(2026, 1, 12))
    };

    private int OmbTotal => OmbDockets.Count;
    private int OmbPending => OmbDockets.Count(d => d.Status.Equals("Pending", StringComparison.OrdinalIgnoreCase));
    private int OmbApprovedRecent => OmbDockets.Count(d =>
        d.Status.Equals("Approved", StringComparison.OrdinalIgnoreCase) &&
        d.UpdatedAt >= DateTime.Today.AddDays(-30));
    private string LatestDocketId => OmbDockets.OrderByDescending(d => d.UpdatedAt).First().Id;
    private string LatestDocketTitle => OmbDockets.OrderByDescending(d => d.UpdatedAt).First().Title;

    private record ReportRow(string Id, string Title, string Status, DateTime GeneratedAt);

    private readonly List<ReportRow> Reports = new()
    {
        new("RPT-2201", "OMB Compliance Summary", "Ready", new DateTime(2026, 1, 15)),
        new("RPT-2202", "ASB Data Quality Report", "Draft", new DateTime(2026, 1, 14)),
        new("RPT-2205", "Yellowbook Validation", "Ready", new DateTime(2026, 1, 13)),
        new("RPT-2206", "ASB Metric Rollup", "Draft", new DateTime(2026, 1, 12))
    };

    private int ReportsTotal => Reports.Count;
    private int ReportsReady => Reports.Count(r => r.Status.Equals("Ready", StringComparison.OrdinalIgnoreCase));
    private int ReportsDraft => Reports.Count(r => r.Status.Equals("Draft", StringComparison.OrdinalIgnoreCase));
    private IEnumerable<ReportRow> RecentReports => Reports
        .OrderByDescending(r => r.GeneratedAt)
        .Take(3);

    private static string ReportStatusClass(string status) => status switch
    {
        "Ready" => "report-status-ready",
        "Draft" => "report-status-draft",
        _ => "report-status-draft"
    };

    private decimal BudgetAllocated => 1_200_000m;
    private decimal BudgetSpent => 740_000m;
    private decimal BudgetRemaining => BudgetAllocated - BudgetSpent;
    private int BudgetSpentPct => BudgetAllocated <= 0 ? 0 : (int)Math.Round((BudgetSpent / BudgetAllocated) * 100m);
    private string BudgetAllocatedDisplay => "$1.2M";
    private string BudgetSpentDisplay => "$740K";
    private string BudgetRemainingDisplay => "$460K";
    private string BudgetAlert => "Travel budget at 82% utilization.";

    private List<TaskCalendar.CalendarEvent> CalendarEvents =>
    Tasks.Select(t => new TaskCalendar.CalendarEvent
    {
        Id = t.Id,
        Start = t.DueAt, // <-- IMPORTANT (CalendarEvent should have Start)
        Title = $"{t.SurveyId} {t.SurveyTitle} — {t.Task}",
        Status = t.Status
    }).ToList();

    private void SelectTask(TaskRow task)
    {
        SelectedEventId = SelectedEventId == task.Id ? null : task.Id;
    }

    private void ClearSelection()
    {
        SelectedEventId = null;
    }


    private static string GetSurveyLink(int surveyId) => $"/surveys/details/{surveyId}";

    private string GetPill(string status) => status switch
    {
        "In progress" => "pill-progress",
        "Blocked" => "pill-blocked",
        "Not started" => "pill-notstarted",
        "Overdue" => "pill-overdue",
        _ => ""
    };
}
