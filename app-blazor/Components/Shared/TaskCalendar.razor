@using System.Globalization
@using Microsoft.JSInterop
@inject IJSRuntime Js

<div class="calendar-wrap" @onclick="ClearSelected">
    <div class="calendar-toolbar">
        <div class="calendar-left">
            <button type="button" class="calendar-button" @onclick="Prev">&#8249;</button>
            <button type="button" class="calendar-button" @onclick="GoToday">Today</button>
            <button type="button" class="calendar-button" @onclick="Next">&#8250;</button>
        </div>

        <div class="calendar-center">
            <div class="calendar-title">@GetTitle()</div>
        </div>

        <div class="calendar-right">
            <select class="calendar-select" @onchange="OnViewChanged">
                <option value="@CalendarViewMode.Day" selected="@(View == CalendarViewMode.Day)">Daily</option>
                <option value="@CalendarViewMode.Week" selected="@(View == CalendarViewMode.Week)">Weekly</option>
                <option value="@CalendarViewMode.Month" selected="@(View == CalendarViewMode.Month)">Monthly</option>
            </select>
        </div>
    </div>



    @if (View == CalendarViewMode.Day)
    {
        <div class="timegrid" @ref="_dayScroll" @onclick:stopPropagation="true">
            <div class="timegrid-header">
                <div></div>
                <div class="timegrid-title"></div>
            </div>


            @foreach (var h in Hours)
            {
                <div class="timegrid-row" data-hour="@h">
                    <div class="timegrid-time">@FormatHour(h)</div>
                    <div class="timegrid-slot">
                        @foreach (var ev in GetEventsForDayHour(AnchorDate, h))
                        {
                            var isSelected = IsSelected(ev);
                            if (isSelected)
                            {
                            <div class="time-ev calendar-event @GetEventClass(ev.Status) selected"
                                 style="@GetEventStyle(ev)"
                                 @onclick="() => SelectEvent(ev)" @onclick:stopPropagation="true" @ref="_selectedEventEl">
                                <div class="time-ev-title">@ev.Title</div>
                                <div class="time-ev-sub">@ev.Start.ToString("h:mm tt")</div>

                                <div class="calendar-pop" @onclick:stopPropagation="true" @ref="_selectedPopEl">
                                    <div class="calendar-pop-head">
                                        <div class="calendar-pop-title">Scheduled task</div>
                                        <button type="button" class="calendar-pop-close" @onclick="ClearSelected" @onclick:stopPropagation="true">×</button>
                                        </div>
                                        <div class="calendar-pop-body">
                                            <div class="calendar-pop-main">@ev.Title</div>
                                            <div class="calendar-pop-meta">@ev.Start.ToString("MMM d, yyyy • h:mm tt")</div>
                                            <span class="calendar-pop-status @GetEventClass(ev.Status)">@ev.Status</span>
                                        </div>
                                    </div>
                                </div>
                            }
                        else
                        {
                            <div class="time-ev calendar-event @GetEventClass(ev.Status)"
                                 style="@GetEventStyle(ev)"
                                 @onclick="() => SelectEvent(ev)" @onclick:stopPropagation="true">
                                <div class="time-ev-title">@ev.Title</div>
                                <div class="time-ev-sub">@ev.Start.ToString("h:mm tt")</div>
                            </div>
                            }
                        }
                    </div>
                </div>
            }
        </div>
    }

    else if (View == CalendarViewMode.Month)
    {
        <div class="calendar-grid calendar-month" @onclick:stopPropagation="true">
            @foreach (var d in DayHeaders)
            {
                <div class="calendar-head">@d</div>
            }

            @foreach (var cell in GetMonthCells())
            {
                <div class="calendar-cell @(cell.IsCurrentMonth ? "" : "muted") @(cell.IsToday ? "today" : "") @(IsSelectedDate(cell.Date) ? "selected-day" : "")">
                    <div class="calendar-daynum">@cell.Date.Day</div>

                    @{
                        var dayEvents = GetEventsForDate(cell.Date);
                        var eventsToShow = dayEvents.Take(3).ToList();
                        if (SelectedEventId.HasValue)
                        {
                            var selected = dayEvents.FirstOrDefault(e => e.Id == SelectedEventId.Value);
                            if (selected != null && eventsToShow.Count > 0 && !eventsToShow.Contains(selected))
                            {
                                eventsToShow[eventsToShow.Count - 1] = selected;
                            }
                        }
                    }

                    @foreach (var ev in eventsToShow)
                    {
                        var isSelected = IsSelected(ev);
                        if (isSelected)
                        {
                            <div class="calendar-ev calendar-event @GetEventClass(ev.Status) selected"
                                 @onclick="() => SelectEvent(ev)" @onclick:stopPropagation="true" @ref="_selectedEventEl">
                                @ev.Title

                                <div class="calendar-pop" @onclick:stopPropagation="true" @ref="_selectedPopEl">
                                    <div class="calendar-pop-head">
                                        <div class="calendar-pop-title">Scheduled task</div>
                                        <button type="button" class="calendar-pop-close" @onclick="ClearSelected" @onclick:stopPropagation="true">×</button>
                                    </div>
                                    <div class="calendar-pop-body">
                                        <div class="calendar-pop-main">@ev.Title</div>
                                        <div class="calendar-pop-meta">@ev.Start.ToString("MMM d, yyyy • h:mm tt")</div>
                                        <span class="calendar-pop-status @GetEventClass(ev.Status)">@ev.Status</span>
                                    </div>
                                </div>
                            </div>
                        }
                        else
                        {
                            <div class="calendar-ev calendar-event @GetEventClass(ev.Status)"
                                 @onclick="() => SelectEvent(ev)" @onclick:stopPropagation="true">
                                @ev.Title
                            </div>
                        }
                    }

                    @{
                        var extra = dayEvents.Count - 3;
                        if (extra > 0)
                        {
                            <div class="calendar-more">+@extra more</div>
                        }
                    }
                </div>
            }
        </div>
    }
    else
    {
        var days = GetWeekDays();

        <div class="weekgrid" @ref="_weekScroll" @onclick:stopPropagation="true">
            <div class="weekgrid-header">
                <div class="weekgrid-corner"></div>
                @foreach (var d in days)
                {
                    <div class="weekgrid-day">@d.ToString("ddd M/d")</div>
                }
            </div>

            @foreach (var h in Hours)
            {
                <div class="weekgrid-row" data-hour="@h">
                    <div class="weekgrid-time">@FormatHour(h)</div>

                    @foreach (var d in days)
                    {
                        <div class="weekgrid-cell">
                            @foreach (var ev in GetEventsForDayHour(d, h))
                            {
                                var isSelected = IsSelected(ev);
                                if (isSelected)
                                {
                                    <div class="week-ev calendar-event @GetEventClass(ev.Status) selected"
                                         style="@GetEventStyle(ev)"
                                         @onclick="() => SelectEvent(ev)" @onclick:stopPropagation="true" @ref="_selectedEventEl">
                                        @ev.Title

                                        <div class="calendar-pop" @onclick:stopPropagation="true" @ref="_selectedPopEl">
                                            <div class="calendar-pop-head">
                                                <div class="calendar-pop-title">Scheduled task</div>
                                                <button type="button" class="calendar-pop-close" @onclick="ClearSelected" @onclick:stopPropagation="true">×</button>
                                            </div>
                                            <div class="calendar-pop-body">
                                                <div class="calendar-pop-main">@ev.Title</div>
                                                <div class="calendar-pop-meta">@ev.Start.ToString("MMM d, yyyy • h:mm tt")</div>
                                                <span class="calendar-pop-status @GetEventClass(ev.Status)">@ev.Status</span>
                                            </div>
                                        </div>
                                    </div>
                                }
                                else
                                {
                                    <div class="week-ev calendar-event @GetEventClass(ev.Status)"
                                         style="@GetEventStyle(ev)"
                                         @onclick="() => SelectEvent(ev)" @onclick:stopPropagation="true">
                                        @ev.Title
                                    </div>
                                }
                            }
                        </div>
                    }
                </div>
            }
        </div>
    }

</div>

@code {
    public enum CalendarViewMode { Day, Week, Month }

    [Parameter] public List<CalendarEvent> Events { get; set; } = new();
    [Parameter] public CalendarViewMode View { get; set; } = CalendarViewMode.Month;
    [Parameter] public EventCallback<CalendarViewMode> ViewChanged { get; set; }

    private DateTime AnchorDate { get; set; } = DateTime.Today;

    private static readonly string[] DayHeaders = new[] { "Mon", "Tue", "Wed", "Thu", "Fri", "Sat", "Sun" };

    public class CalendarEvent
    {
        public int Id { get; set; }
        public DateTime Start { get; set; }
        public string Title { get; set; } = "";
        public string Status { get; set; } = "";
    }

    [Parameter] public int? SelectedEventId { get; set; }
    [Parameter] public EventCallback<int?> SelectedEventIdChanged { get; set; }

    private ElementReference _dayScroll;
    private ElementReference _weekScroll;
    private ElementReference _selectedEventEl;
    private ElementReference _selectedPopEl;
    private int? _lastSelectedEventId;
    private bool _pendingScroll;
    private bool _pendingScrollToHour;
    private bool _pendingPopoverPosition;

    private async Task OnViewChanged(ChangeEventArgs e)
    {
        if (e.Value is null)
            return;

        if (Enum.TryParse<CalendarViewMode>(e.Value.ToString(), out var view))
        {
            await SetView(view);
        }
    }

    protected override void OnParametersSet()
    {
        if (SelectedEventId != _lastSelectedEventId)
        {
            _pendingScroll = SelectedEventId.HasValue;
            _pendingPopoverPosition = SelectedEventId.HasValue;
            _lastSelectedEventId = SelectedEventId;
        }

        if (SelectedEventId.HasValue)
        {
            var selected = Events.FirstOrDefault(e => e.Id == SelectedEventId.Value);
            if (selected != null)
            {
                AnchorDate = View == CalendarViewMode.Week
                    ? GetWeekStart(selected.Start)
                    : selected.Start.Date;
            }
        }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (!_pendingScroll || !SelectedEventId.HasValue)
        {
            if (firstRender && (View == CalendarViewMode.Day || View == CalendarViewMode.Week))
            {
                await ScrollToWorkdayStart();
            }
        }
        else
        {
            if (View == CalendarViewMode.Day)
            {
                await Js.InvokeVoidAsync("smsScrollToEvent", _dayScroll, _selectedEventEl);
                _pendingScroll = false;
            }
            else if (View == CalendarViewMode.Week)
            {
                await Js.InvokeVoidAsync("smsScrollToEvent", _weekScroll, _selectedEventEl);
                _pendingScroll = false;
            }

            await Js.InvokeVoidAsync("smsPositionPopover", _selectedEventEl, _selectedPopEl);
            _pendingPopoverPosition = false;
        }

        if (_pendingPopoverPosition && SelectedEventId.HasValue)
        {
            await Js.InvokeVoidAsync("smsPositionPopover", _selectedEventEl, _selectedPopEl);
            _pendingPopoverPosition = false;
        }

        if (_pendingScrollToHour && !SelectedEventId.HasValue && (View == CalendarViewMode.Day || View == CalendarViewMode.Week))
        {
            await ScrollToWorkdayStart();
            _pendingScrollToHour = false;
        }
    }

    private async Task SetView(CalendarViewMode mode)
    {
        View = mode;
        if (ViewChanged.HasDelegate)
            await ViewChanged.InvokeAsync(mode);

        // Optional: snap to Monday when switching to Week
        if (mode == CalendarViewMode.Week)
            AnchorDate = GetWeekStart(AnchorDate);
        else if (SelectedEventId.HasValue)
        {
            var selected = Events.FirstOrDefault(e => e.Id == SelectedEventId.Value);
            if (selected != null)
                AnchorDate = selected.Start.Date;
        }

        if (SelectedEventId.HasValue && (mode == CalendarViewMode.Day || mode == CalendarViewMode.Week))
        {
            _pendingScroll = true;
            _pendingPopoverPosition = true;
        }
        else if (mode == CalendarViewMode.Day || mode == CalendarViewMode.Week)
            _pendingScrollToHour = true;
    }

    private string GetEventClass(string status) => status switch
    {
        "In progress" => "ev-progress",
        "Blocked" => "ev-blocked",
        "Not started" => "ev-notstarted",
        "Overdue" => "ev-overdue",
        _ => ""
    };

    private void GoToday() => AnchorDate = DateTime.Today;

    private void Prev()
    {
        AnchorDate = View switch
        {
            CalendarViewMode.Day => AnchorDate.AddDays(-1),
            CalendarViewMode.Week => AnchorDate.AddDays(-7),
            CalendarViewMode.Month => AnchorDate.AddMonths(-1),
            _ => AnchorDate
        };
    }

    private void Next()
    {
        AnchorDate = View switch
        {
            CalendarViewMode.Day => AnchorDate.AddDays(1),
            CalendarViewMode.Week => AnchorDate.AddDays(7),
            CalendarViewMode.Month => AnchorDate.AddMonths(1),
            _ => AnchorDate
        };
    }

    private bool IsSelected(CalendarEvent ev) =>
        SelectedEventId.HasValue && ev.Id == SelectedEventId.Value;

    private async Task SelectEvent(CalendarEvent ev)
    {
        SelectedEventId = ev.Id;
        _pendingScroll = true;
        _pendingPopoverPosition = true;
        if (SelectedEventIdChanged.HasDelegate)
            await SelectedEventIdChanged.InvokeAsync(SelectedEventId);
    }

    private async Task ClearSelected()
    {
        SelectedEventId = null;
        _pendingScroll = false;
        _pendingPopoverPosition = false;
        if (View == CalendarViewMode.Day || View == CalendarViewMode.Week)
            _pendingScrollToHour = true;
        if (SelectedEventIdChanged.HasDelegate)
            await SelectedEventIdChanged.InvokeAsync(null);
    }

    private bool IsSelectedDate(DateTime date) =>
        SelectedEventId.HasValue && Events.Any(e => e.Id == SelectedEventId.Value && e.Start.Date == date.Date);

    private async Task ScrollToWorkdayStart()
    {
        if (View == CalendarViewMode.Day)
            await Js.InvokeVoidAsync("smsScrollToHour", _dayScroll, 9);
        else if (View == CalendarViewMode.Week)
            await Js.InvokeVoidAsync("smsScrollToHour", _weekScroll, 9);
    }

    private string GetTitle()
    {
        return View switch
        {
            CalendarViewMode.Month => AnchorDate.ToString("MMMM yyyy", CultureInfo.InvariantCulture),

            CalendarViewMode.Week => $"{GetWeekStart(AnchorDate):MMM d} \u2013 {GetWeekStart(AnchorDate).AddDays(6):MMM d, yyyy}",

            CalendarViewMode.Day => AnchorDate.ToString("dddd, MMM d, yyyy", CultureInfo.InvariantCulture),

            _ => AnchorDate.ToString("MMM d, yyyy", CultureInfo.InvariantCulture)
        };
    }

    private DateTime GetWeekStart(DateTime date)
    {
        // Monday-based week
        var diff = (7 + (date.DayOfWeek - DayOfWeek.Monday)) % 7;
        return date.Date.AddDays(-diff);
    }

    // ===== Month helpers =====

    private IEnumerable<MonthCell> GetMonthCells()
    {
        var firstOfMonth = new DateTime(AnchorDate.Year, AnchorDate.Month, 1);
        var start = GetWeekStart(firstOfMonth); // start grid on Monday

        for (int i = 0; i < 42; i++) // 6 weeks grid
        {
            var day = start.AddDays(i);
            yield return new MonthCell
            {
                Date = day,
                IsCurrentMonth = day.Month == AnchorDate.Month,
                IsToday = day.Date == DateTime.Today.Date
            };
        }
    }

    private class MonthCell
    {
        public DateTime Date { get; set; }
        public bool IsCurrentMonth { get; set; }
        public bool IsToday { get; set; }
    }

    private List<CalendarEvent> GetEventsForDate(DateTime date) =>
    Events
    .Where(e => e.Start.Date == date.Date)
    .OrderBy(e => e.Start)
    .ToList();

    // ===== Day/Week time-grid helpers =====

    private IEnumerable<int> Hours => Enumerable.Range(0, 24);

    private string FormatHour(int hour)
    {
        var dt = new DateTime(2000, 1, 1, hour, 0, 0);
        return dt.ToString("h tt", CultureInfo.InvariantCulture); // 1 AM, 2 PM...
    }

    private List<DateTime> GetWeekDays()
    {
        var start = GetWeekStart(AnchorDate);
        return Enumerable.Range(0, 7).Select(i => start.AddDays(i)).ToList();
    }

    private List<CalendarEvent> GetEventsForDayHour(DateTime day, int hour) =>
    Events
    .Where(e => e.Start.Date == day.Date && e.Start.Hour == hour)
    .OrderBy(e => e.Start)
    .ToList();

    private string GetEventStyle(CalendarEvent ev)
    {
        var offset = Math.Clamp(ev.Start.Minute / 60.0, 0, 0.99);
        return $"--event-offset:{offset:0.##}";
    }
}
